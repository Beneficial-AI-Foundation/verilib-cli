# Reusable workflow for verilib verification
#
# Usage in any Verus project:
#
#   jobs:
#     verify:
#       uses: beneficial-ai-foundation/verilib-cli/.github/workflows/verilib-verify.yml@v1
#       with:
#         project-path: .
#       secrets:
#         VERILIB_API_KEY: ${{ secrets.VERILIB_API_KEY }}

name: verilib Verify

on:
  workflow_call:
    inputs:
      project-path:
        description: 'Path to the Verus project'
        required: false
        type: string
        default: '.'
      verus-version:
        description: 'Verus version (default: auto-detect from Cargo.toml)'
        required: false
        type: string
        default: ''
      rust-version:
        description: 'Rust toolchain version (default: auto-detect from Cargo.toml)'
        required: false
        type: string
        default: ''
      functions-to-track:
        description: 'Path to functions_to_track.csv'
        required: false
        type: string
        default: ''
      deploy-enabled:
        description: 'Enable deployment to verilib backend after verification (requires VERILIB_API_KEY secret and repo-id)'
        required: false
        type: boolean
        default: false
      repo-id:
        description: 'Verilib repository ID (used for deploy; optional if .verilib/config.json is in repo)'
        required: false
        type: string
        default: ''
    secrets:
      VERILIB_API_KEY:
        description: 'API key for verilib backend (required when deploy-enabled is true)'
        required: false
    outputs:
      verified-count:
        description: 'Number of functions verified'
        value: ${{ jobs.verify.outputs.verified-count }}
      total-functions:
        description: 'Total number of tracked functions'
        value: ${{ jobs.verify.outputs.total-functions }}

jobs:
  verify:
    name: Verify
    runs-on: ubuntu-latest
    outputs:
      verified-count: ${{ steps.verilib.outputs.verified-count }}
      total-functions: ${{ steps.verilib.outputs.total-functions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run verilib verification
        id: verilib
        uses: ./action
        with:
          project-path: ${{ inputs.project-path }}
          # On push to main/master: generate mode
          # On PR: check mode
          mode: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') ? 'generate' : 'check' }}
          verus-version: ${{ inputs.verus-version }}
          rust-version: ${{ inputs.rust-version }}
          functions-to-track: ${{ inputs.functions-to-track }}

      - name: Create summary
        run: |
          echo "## Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Verified | ${{ steps.verilib.outputs.verified-count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ steps.verilib.outputs.total-functions }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verilib.outputs.total-functions }}" -gt 0 ]; then
            PERCENT=$(( ${{ steps.verilib.outputs.verified-count }} * 100 / ${{ steps.verilib.outputs.total-functions }} ))
            echo "**Coverage: ${PERCENT}%**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload verilib artifacts
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: actions/upload-artifact@v4
        with:
          name: verilib-results
          # Use the archive to avoid issues with special characters in filenames
          path: ${{ steps.verilib.outputs.results-archive }}
          retention-days: 30

  # NOTE: This deploy job currently uses `verilib-cli reclone`, which tells the
  # backend to re-clone and re-process the repo from scratch. This is a stopgap:
  # it does NOT upload the .verilib/ artifacts generated by the verify job above.
  # A proper solution will use `verilib-cli deploy` (once wired into the CLI) to
  # upload the generated artifacts directly, avoiding redundant server-side work.
  # See: https://github.com/Beneficial-AI-Foundation/verilib-cli/issues/36
  deploy:
    name: Deploy to verilib
    needs: verify
    if: |
      inputs.deploy-enabled &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to verilib backend
        uses: ./action/deploy
        with:
          api-key: ${{ secrets.VERILIB_API_KEY }}
          repo-id: ${{ inputs.repo-id }}
