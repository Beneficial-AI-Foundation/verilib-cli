# verilib-cli Deploy Action
# Triggers backend re-processing via verilib-cli reclone
#
# NOTE: This action uses `verilib-cli reclone` as a stopgap. Reclone tells the
# backend to re-clone and re-process the repository from scratch, which means
# the .verilib/ artifacts (stubs, atoms, specs, proofs) generated by the CI
# verify step are NOT uploaded and the server duplicates that work.
#
# A proper solution will use `verilib-cli deploy` (once wired into the CLI,
# see https://github.com/Beneficial-AI-Foundation/verilib-cli/issues/36) to
# upload the generated artifacts directly. When that is ready, this action
# should switch from `verilib-cli reclone` to `verilib-cli deploy` and accept
# the verify job's artifacts as input.
#
# Usage:
#   - uses: beneficial-ai-foundation/verilib-cli/action/deploy@v1
#     with:
#       api-key: ${{ secrets.VERILIB_API_KEY }}
#       repo-id: '42'

name: 'verilib Deploy'
description: 'Deploy verification results to the verilib backend via reclone'
author: 'Beneficial AI Foundation'

branding:
  icon: 'upload-cloud'
  color: 'green'

inputs:
  api-key:
    description: 'Verilib API key (from secrets)'
    required: true
  repo-id:
    description: 'Verilib repository ID'
    required: true
  api-url:
    description: 'Verilib API base URL'
    required: false
    default: 'https://verilib.org'
  debug:
    description: 'Enable debug output'
    required: false
    default: 'false'

outputs:
  status:
    description: 'Deploy status (success or failure)'
    value: ${{ steps.deploy.outputs.status }}

runs:
  using: 'composite'
  steps:
    # Step 1: Install Rust toolchain
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    # Step 2: Cache cargo registry
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          ~/.cargo/bin
        key: ${{ runner.os }}-cargo-verilib-deploy-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-verilib-deploy-
          ${{ runner.os }}-cargo-

    # Step 3: Install system dependencies (libdbus for keyring crate)
    - name: Install system dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y libdbus-1-dev pkg-config

    # Step 4: Install verilib-cli
    - name: Install verilib-cli
      shell: bash
      run: |
        if command -v verilib-cli &> /dev/null; then
          echo "verilib-cli already installed (from cache)"
        else
          echo "Installing verilib-cli..."
          cargo install --force --git https://github.com/Beneficial-AI-Foundation/verilib-cli
        fi
        verilib-cli --version || echo "verilib-cli installed"

    # Step 5: Set up authentication
    - name: Set up API key
      shell: bash
      env:
        VERILIB_API_KEY: ${{ inputs.api-key }}
      run: |
        # verilib-cli on Linux uses file storage (~/.verilib_credentials)
        echo -n "$VERILIB_API_KEY" > ~/.verilib_credentials
        chmod 600 ~/.verilib_credentials
        echo "API key configured for file storage"

    # Step 6: Create config.json if not present
    - name: Ensure config.json
      shell: bash
      env:
        REPO_ID: ${{ inputs.repo-id }}
        API_URL: ${{ inputs.api-url }}
      run: |
        mkdir -p .verilib

        # If config.json already exists with repo info, use it
        if [ -f ".verilib/config.json" ]; then
          EXISTING_ID=$(cat .verilib/config.json | jq -r '.repo.id // empty' 2>/dev/null)
          if [ -n "$EXISTING_ID" ]; then
            echo "Using existing config.json (repo ID: $EXISTING_ID)"
            exit 0
          fi
        fi

        # Create config.json with provided repo-id
        jq -n \
          --arg id "$REPO_ID" \
          --arg url "$API_URL" \
          '{"repo": {"id": $id, "url": $url, "is_admin": false}}' \
          > .verilib/config.json
        echo "Created config.json (repo ID: $REPO_ID, URL: $API_URL)"

    # Step 7: Run reclone
    - name: Deploy via reclone
      id: deploy
      shell: bash
      env:
        VERILIB_STORAGE: file
      run: |
        echo "=== Deploying to verilib backend ==="

        DEBUG_FLAG=""
        if [ "${{ inputs.debug }}" = "true" ]; then
          DEBUG_FLAG="--debug"
        fi

        if verilib-cli reclone $DEBUG_FLAG; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "=== Deploy complete ==="
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "::error::Deploy failed"
          exit 1
        fi

    # Step 8: Clean up credentials
    - name: Clean up credentials
      if: always()
      shell: bash
      run: |
        rm -f ~/.verilib_credentials
        echo "Credentials cleaned up"
